---
title: "Ecuador Survival Exploratory Analysis"
author: "Laura Graham"
date: "14/04/2015"
output: html_document
---

```{r, include=FALSE}
require(Hmisc)
require(dplyr)
require(tidyr)
require(taxize)

# read in the table from full_data.mdb and write out to banding_sheet.csv - this
# gets rid of column attribute issues
banding.dat <- mdb.get("data/full_data.mdb", tables="Banding Sheet")
write.csv(banding.dat, file="data/banding_sheet.csv")

# re-read in data
banding.dat <- read.csv("data/banding_sheet.csv", stringsAsFactors = FALSE)
```
Variables for use in the analysis are `Band.Number`, `Specie.Name`, `Band.Size`, `Session`. Band size is included because this gives an idea of whether the individual has previously been banded and thus can find those records where the banding has not been recorded. 

# Missing data
Number of records with:

* no band number (`Band.Number == 99999`): `r nrow(filter(banding.dat, Band.Number == 99999))`
* no species name (`Specie.Name %in% c("", "U", "99999")`): `r nrow(filter(banding.dat, Specie.Name %in% c("", "U", "99999")))`
* no session (`Session == ""`): `r nrow(filter(banding.dat, Session == ""))`

# Summary of data
```{r, include=FALSE}
# remove missing data
banding.dat.clean <- filter(banding.dat, Band.Number != 99999, 
                            !(Specie.Name %in% c("", "U", "99999")), 
                            Session != "")

# get a list of the species in the dataset and use taxize to resolve the family
# (for filtering)
species.names <- unique(banding.dat.clean$Specie.Name)
species.family <- tax_name(query = species.names, 
                                  get = "family", db = "itis")
species.lookup <- data.frame(Specie.Name = species.names, 
                             family = species.family,
                             stringsAsFactors = FALSE)

# NOTE: should have been Eriocnemis vestita, have updated the family to
# Trochilidae so that it gets picked up in the hummingbird subset. NB there are
# other NAs, but they are not hummingbirds, if other families are of interest in
# the analysis need to update the rest of the NAs
species.lookup[species.lookup$Specie.Name == "ERIOCNEMIS VESTITUS",2]  <- "Trochilidae"

# create a lookup for the sessions so that they are ordered correctly
session.lookup <- data.frame(Session = unique(banding.dat.clean$Session))
session.name.length <- nchar(as.character(session.lookup$Session))
session.lookup$session_new <- paste0(
        "session_"
        , substr(session.lookup$Session, session.name.length - 1, session.name.length)
        , "_"
        , substr(session.lookup$Session, 1, 3))

# merge lookup with the dataset 
banding.dat.clean <- merge(banding.dat.clean, session.lookup)

# create a subset which only includes hummingbird data
banding.dat.clean <- merge(banding.dat.clean, species.lookup)
hummer.dat <- filter(banding.dat.clean, family == "Trochilidae")
```

Once missing data has been removed, there are a total of `r nrow(banding.dat.clean)` records (`r nrow(banding.dat) - nrow(banding.dat.clean)` records removed). 

In the data there are:

- `r length(unique(banding.dat.clean$Specie.Name))` species
- `r length(unique(banding.dat.clean$Band.Number))` individuals
- `r length(unique(hummer.dat$Specie.Name))` hummingbird species
- `r length(unique(hummer.dat$Band.Number))` hummingbird individuals

Some individuals have been recorded as recaptures (`Band.Size == "RE"`) without having had their initial banding recorded. See below for info.

```{r, echo=FALSE}
# get only records recorded as recaptures
recap.rec <- filter(banding.dat.clean, Code == "R")

# get only records recorded as first banding
banding.rec <- filter(banding.dat.clean, Code != "R")

# find those individuals which are recorded as recaptures without a first banding
no.first.band <- filter(recap.rec, !(Band.Number %in% banding.rec$Band.Number)) %>%
        group_by(family, Specie.Name, Band.Number) %>%
        summarise(count = length(Band.Number)) %>%
        arrange(-count)

hb.no.first.band <- filter(no.first.band, family == "Trochilidae")
print(no.first.band)
```

Some of the band numbers are recorded as more than one species. 
```{r, echo=FALSE}
# Code to create the encounter histories - will most likely move this into a new
# file with some of the clean-up code once I've started writing this.

# First part creates one line per record
encounter.history <- 
        select(banding.dat.clean, RU, Specie.Name, Band.Number, family, session_new) %>%
        mutate(count=1) %>%
        spread(session_new, count) 

encounter.history[is.na(encounter.history)] <- 0

# This code summarises and creates one line per species/band.number combo
encounter.history <- group_by(encounter.history, Specie.Name, Band.Number, family) %>%
        summarise_each(funs(sum))

encounter.history[,5:ncol(encounter.history)][encounter.history[,5:ncol(encounter.history)] > 1] <- 1

# Filter by Trochilidae to get the hummingbird encounter history
hb.encounter.history <- filter(encounter.history, family=="Trochilidae")
hb.tot.encounters <- data.frame(Species = hb.encounter.history$Specie.Name, 
                                Band.Number = hb.encounter.history$Band.Number, 
                                encounters=rowSums(hb.encounter.history[,5:31]))

dupes <- encounter.history[which(duplicated(encounter.history$Band.Number)),2]
dup.bands <- filter(encounter.history, Band.Number %in% dupes$Band.Number)
dup.bands <- arrange(dup.bands, Band.Number)
hummers <- filter(species.lookup, family == "Trochilidae")
hb.dup.bands <- filter(dup.bands, Specie.Name %in% hummers$Specie.Name) %>%
        arrange(Band.Number)

# get the original records where the same band number is used for more than one
# species
dup.bands.dat <- filter(banding.dat, Band.Number %in% dup.bands$Band.Number) %>%
        arrange(Band.Number)
hb.dup.bands.dat <- filter(banding.dat, Band.Number %in% 
                                        hb.dup.bands$Band.Number) %>%
        arrange(Band.Number)
```
There are a total of `r nrow(dup.bands.dat)` records which are affected by this (`r length(unique(dup.bands.dat$Band.Number))` band numbers). There are a total of `r nrow(hb.dup.bands.dat)` hummingbird records affected (`r length(unique(hb.dup.bands.dat$Band.Number))` band numbers). 

```{r, echo=FALSE}
sp.enc <- group_by(hb.encounter.history, Specie.Name) %>%
        summarise(count = length(Specie.Name))

print(sp.enc)
```